<script>
document.addEventListener("DOMContentLoaded", () => {
  const SYNC_URL = "https://ghl-sync.blugritdigital.workers.dev/";

  // ---- helpers ----
  const el = id => document.getElementById(id);
  const safeText = (id, txt) => { const e=el(id); if(e) e.textContent = txt; };

  let email = localStorage.getItem("email") || "";
  let phone = localStorage.getItem("phone") || "";

  // prompt user once
  (async function init(){
    try {
      if(!email && !phone){
        const usePhone = confirm("Use phone to find your bookings? (Cancel for email)");
        if(usePhone){
          phone = prompt("Your mobile number (digits only):","");
          if(phone) localStorage.setItem("phone", phone);
        } else {
          email = prompt("Your email:","");
          if(email) localStorage.setItem("email", email);
        }
      }

      safeText("sub", "Syncing your visits…");

      const url = new URL(SYNC_URL);
      if(email) url.searchParams.set("email", email);
      if(phone) url.searchParams.set("phone", phone);

      const res = await fetch(url, { cache: "no-store" });
      const txt = await res.text();

      // show raw output if not JSON
      let data;
      try { data = JSON.parse(txt); }
      catch {
        document.body.innerHTML =
          "<pre style='white-space:pre-wrap;padding:20px;background:#fff;border-radius:12px;font-size:14px'>" +
          "⚠️ Worker returned non-JSON response:\n\n" +
          txt.replace(/[<>&]/g, c=>({"<":"&lt;",">":"&gt;","&":"&amp;"}[c])) +
          "</pre>";
        return;
      }

      console.log("Worker data →", data);

      if(!data.contact){
        safeText("sub","No contact found — check your email/phone.");
        return;
      }

      const name = [data.contact.firstName, data.contact.lastName].filter(Boolean).join(" ");
      safeText("name", name || "Beautiful");
      const next = data.upcoming?.[0];
      safeText("next", next ? new Date(next.startTime).toLocaleString() : "—");
      safeText("rw", data.visitCount ?? 0);
      safeText("sub","Synced ✨");
    }
    catch(err){
      console.error(err);
      safeText("sub","Could not sync right now.");
      // show message box instead of blank
      document.body.insertAdjacentHTML("beforeend",
        "<div style='padding:20px;color:#900;background:#fee;margin:20px;border-radius:8px'>"+
        "⚠️ JS Error: "+err.message+"</div>");
    }

    // safety: ensure reset always works
    const reset = el("reset");
    if(reset) reset.onclick = e => { e.preventDefault(); localStorage.clear(); location.reload(); };
  })();
});
</script>

