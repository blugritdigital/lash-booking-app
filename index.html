<script>
document.addEventListener("DOMContentLoaded", () => {
  const SYNC_URL = "https://ghl-sync.blugritdigital.workers.dev/";

  const el = (id) => document.getElementById(id);
  const msgBox = document.createElement("div");
  msgBox.style.cssText =
    "position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:2px solid #ccc;padding:12px;font-family:monospace;font-size:14px;max-height:40vh;overflow:auto;z-index:9999;";
  document.body.appendChild(msgBox);
  function log(msg, color="#222") {
    const line = document.createElement("div");
    line.style.color = color;
    line.textContent = msg;
    msgBox.appendChild(line);
    console.log("[App]", msg);
  }

  async function init() {
    log("App started");

    let email = localStorage.getItem("email") || "";
    let phone = localStorage.getItem("phone") || "";

    if (!email && !phone) {
      const usePhone = confirm("Use phone to find your bookings? (Cancel for email)");
      if (usePhone) {
        phone = prompt("Enter phone (digits only):", "");
        if (phone) localStorage.setItem("phone", phone);
      } else {
        email = prompt("Enter email:", "");
        if (email) localStorage.setItem("email", email);
      }
    }
    log(`Using email=${email || "—"}, phone=${phone || "—"}`);

    const url = new URL(SYNC_URL);
    if (email) url.searchParams.set("email", email);
    if (phone) url.searchParams.set("phone", phone);
    log("Fetching → " + url);

    try {
      const res = await fetch(url, { cache: "no-store" });
      log("Response status: " + res.status);

      const text = await res.text();
      log("Raw response: " + text.slice(0, 300) + (text.length > 300 ? "..." : ""));

      let data;
      try {
        data = JSON.parse(text);
      } catch (err) {
        log("❌ JSON parse error: " + err.message, "red");
        document.body.innerHTML +=
          "<pre style='background:#fff;padding:20px;border-radius:12px'>" +
          text.replace(/[<>&]/g, (c) => ({ "<": "&lt;", ">": "&gt;", "&": "&amp;" }[c])) +
          "</pre>";
        return;
      }

      log("✅ Parsed JSON successfully");

      if (!data.contact) {
        log("No contact found in data", "red");
        el("sub")?.textContent = "No contact found — check email/phone.";
        return;
      }

      const fullName = [data.contact.firstName, data.contact.lastName].filter(Boolean).join(" ");
      log("Contact found: " + fullName);
      el("name")?.textContent = fullName || "Beautiful";

      const nextAppt = data.upcoming?.[0];
      el("next")?.textContent = nextAppt
        ? new Date(nextAppt.startTime).toLocaleString()
        : "—";
      el("rw")?.textContent = data.visitCount ?? 0;
      el("sub")?.textContent = "Synced ✨";
      log("All DOM updates done");
    } catch (err) {
      log("❌ JS error: " + err.message, "red");
      el("sub")?.textContent = "Could not sync right now.";
    }
  }

  init();
});
</script>


